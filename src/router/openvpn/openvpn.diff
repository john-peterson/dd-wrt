diff -urN openvpn-2.1_rc14/ChangeLog openvpn-2.1_rc15/ChangeLog
--- openvpn-2.1_rc14/ChangeLog	2008-11-17 05:38:17.000000000 +0100
+++ openvpn-2.1_rc15/ChangeLog	2008-11-19 19:17:39.000000000 +0100
@@ -1,7 +1,34 @@
 OpenVPN
 Copyright (C) 2002-2008 OpenVPN Technologies, Inc. <sales@openvpn.net>
 
-$Id: ChangeLog 3495 2008-11-17 04:28:07Z james $
+$Id: ChangeLog 3525 2008-11-19 18:17:39Z james $
+
+2008.11.19 -- Version 2.1_rc15
+
+* Fixed issue introduced in 2.1_rc14 that may cause a
+  segfault when a --plugin module is used.
+
+* Added server-side --opt-verify option: clients that connect
+  with options that are incompatible with those of the server
+  will be disconnected (without this option, incompatible
+  clients would trigger a warning message in the server log
+  but would not be disconnected).
+
+* Added --tcp-nodelay option: Macro that sets TCP_NODELAY socket
+  flag on the server as well as pushes it to connecting clients.
+
+* Minor options check fix: --no-name-remapping is a
+  server-only option and should therefore generate an
+  error when used on the client.
+
+* Added --prng option to control PRNG (pseudo-random
+  number generator) parameters.  In previous OpenVPN
+  versions, the PRNG was hardcoded to use the SHA1
+  hash.  Now any OpenSSL hash may be used.  This is
+  part of an effort to remove hardcoded references to
+  a specific cipher or cryptographic hash algorithm.
+
+* Cleaned up man page synopsis.
 
 2008.11.16 -- Version 2.1_rc14
 
diff -urN openvpn-2.1_rc14/config-win32.h openvpn-2.1_rc15/config-win32.h
--- openvpn-2.1_rc14/config-win32.h	2008-11-17 05:39:49.000000000 +0100
+++ openvpn-2.1_rc15/config-win32.h	2008-11-19 19:18:24.000000000 +0100
@@ -228,7 +228,7 @@
 #define PACKAGE_TARNAME openvpn
 
 /* Define to the version of this package. */
-#define PACKAGE_VERSION 2.1_rc14
+#define PACKAGE_VERSION 2.1_rc15
 
 /* Define to the full name and version of this package. */
 #ifdef DEBUG_LABEL
diff -urN openvpn-2.1_rc14/configure openvpn-2.1_rc15/configure
--- openvpn-2.1_rc14/configure	2008-11-17 05:39:17.000000000 +0100
+++ openvpn-2.1_rc15/configure	2008-11-19 19:17:50.000000000 +0100
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.61 for OpenVPN 2.1_rc14.
+# Generated by GNU Autoconf 2.61 for OpenVPN 2.1_rc15.
 #
 # Report bugs to <openvpn-users@lists.sourceforge.net>.
 #
@@ -574,8 +574,8 @@
 # Identity of this package.
 PACKAGE_NAME='OpenVPN'
 PACKAGE_TARNAME='openvpn'
-PACKAGE_VERSION='2.1_rc14'
-PACKAGE_STRING='OpenVPN 2.1_rc14'
+PACKAGE_VERSION='2.1_rc15'
+PACKAGE_STRING='OpenVPN 2.1_rc15'
 PACKAGE_BUGREPORT='openvpn-users@lists.sourceforge.net'
 
 ac_unique_file="syshead.h"
@@ -1232,7 +1232,7 @@
   # Omit some internal or obsolete options to make the list less imposing.
   # This message is too long to be a string in the A/UX 3.1 sh.
   cat <<_ACEOF
-\`configure' configures OpenVPN 2.1_rc14 to adapt to many kinds of systems.
+\`configure' configures OpenVPN 2.1_rc15 to adapt to many kinds of systems.
 
 Usage: $0 [OPTION]... [VAR=VALUE]...
 
@@ -1303,7 +1303,7 @@
 
 if test -n "$ac_init_help"; then
   case $ac_init_help in
-     short | recursive ) echo "Configuration of OpenVPN 2.1_rc14:";;
+     short | recursive ) echo "Configuration of OpenVPN 2.1_rc15:";;
    esac
   cat <<\_ACEOF
 
@@ -1425,7 +1425,7 @@
 test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
-OpenVPN configure 2.1_rc14
+OpenVPN configure 2.1_rc15
 generated by GNU Autoconf 2.61
 
 Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
@@ -1439,7 +1439,7 @@
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
-It was created by OpenVPN $as_me 2.1_rc14, which was
+It was created by OpenVPN $as_me 2.1_rc15, which was
 generated by GNU Autoconf 2.61.  Invocation command line was
 
   $ $0 $@
@@ -13235,7 +13235,7 @@
 # report actual input values of CONFIG_FILES etc. instead of their
 # values after options handling.
 ac_log="
-This file was extended by OpenVPN $as_me 2.1_rc14, which was
+This file was extended by OpenVPN $as_me 2.1_rc15, which was
 generated by GNU Autoconf 2.61.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
@@ -13288,7 +13288,7 @@
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF
 ac_cs_version="\\
-OpenVPN config.status 2.1_rc14
+OpenVPN config.status 2.1_rc15
 configured by $0, generated by GNU Autoconf 2.61,
   with options \\"`echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
 
diff -urN openvpn-2.1_rc14/crypto.c openvpn-2.1_rc15/crypto.c
--- openvpn-2.1_rc14/crypto.c	2008-10-06 09:22:21.000000000 +0200
+++ openvpn-2.1_rc15/crypto.c	2008-11-18 01:51:58.000000000 +0100
@@ -1640,6 +1640,7 @@
       engine_initialized = false;
     }
 #endif
+  prng_uninit ();
 }
 
 /*
@@ -1649,33 +1650,73 @@
  * IV values and a number of other miscellaneous tasks.
  */
 
-#define NONCE_SECRET_LEN 16
+static uint8_t *nonce_data; /* GLOBAL */
+static const EVP_MD *nonce_md = NULL; /* GLOBAL */
+static int nonce_secret_len; /* GLOBAL */
 
-static uint8_t nonce_data [SHA_DIGEST_LENGTH + NONCE_SECRET_LEN]; /* GLOBAL */
+void
+prng_init (const char *md_name, const int nonce_secret_len_parm)
+{
+  prng_uninit ();
+  nonce_md = md_name ? get_md (md_name) : NULL;
+  if (nonce_md)
+    {
+      ASSERT (nonce_secret_len_parm >= NONCE_SECRET_LEN_MIN && nonce_secret_len_parm <= NONCE_SECRET_LEN_MAX);
+      nonce_secret_len = nonce_secret_len_parm;
+      {
+	const int size = EVP_MD_size (nonce_md) + nonce_secret_len;
+	dmsg (D_CRYPTO_DEBUG, "PRNG init md=%s size=%d", EVP_MD_name (nonce_md), size);
+	nonce_data = (uint8_t*) malloc (size);
+	check_malloc_return (nonce_data);
+#if 1 /* Must be 1 for real usage */
+	if (!RAND_bytes (nonce_data, size))
+	  msg (M_FATAL, "ERROR: Random number generator cannot obtain entropy for PRNG");
+#else
+	/* Only for testing -- will cause a predictable PRNG sequence */
+	{
+	  int i;
+	  for (i = 0; i < size; ++i)
+	    nonce_data[i] = (uint8_t) i;
+	}
+#endif
+      }
+    }
+}
 
 void
-prng_init (void)
+prng_uninit (void)
 {
-  if (!RAND_bytes (nonce_data, sizeof(nonce_data)))
-    msg (M_FATAL, "ERROR: Random number generator cannot obtain entropy for PRNG");
+  free (nonce_data);
+  nonce_data = NULL;
+  nonce_md = NULL;
+  nonce_secret_len = 0;
 }
 
 void
 prng_bytes (uint8_t *output, int len)
 {
-  SHA_CTX ctx;
-  mutex_lock_static (L_PRNG);
-  while (len > 0)
+  if (nonce_md)
     {
-      const int blen = min_int (len, SHA_DIGEST_LENGTH);
-      SHA1_Init (&ctx);
-      SHA1_Update (&ctx, nonce_data, sizeof (nonce_data));
-      SHA1_Final (nonce_data, &ctx);
-      memcpy (output, nonce_data, blen);
-      output += blen;
-      len -= blen;
+      EVP_MD_CTX ctx;
+      const int md_size = EVP_MD_size (nonce_md);
+      mutex_lock_static (L_PRNG);
+      while (len > 0)
+	{
+	  unsigned int outlen = 0;
+	  const int blen = min_int (len, md_size);
+	  EVP_DigestInit (&ctx, nonce_md);
+	  EVP_DigestUpdate (&ctx, nonce_data, md_size + nonce_secret_len);
+	  EVP_DigestFinal (&ctx, nonce_data, &outlen);
+	  ASSERT (outlen == md_size);
+	  EVP_MD_CTX_cleanup (&ctx);
+	  memcpy (output, nonce_data, blen);
+	  output += blen;
+	  len -= blen;
+	}
+      mutex_unlock_static (L_PRNG);
     }
-  mutex_unlock_static (L_PRNG);
+  else
+    RAND_bytes (output, len);
 }
 
 /* an analogue to the random() function, but use prng_bytes */
diff -urN openvpn-2.1_rc14/crypto.h openvpn-2.1_rc15/crypto.h
--- openvpn-2.1_rc14/crypto.h	2008-10-06 09:22:21.000000000 +0200
+++ openvpn-2.1_rc15/crypto.h	2008-11-17 21:00:22.000000000 +0100
@@ -329,8 +329,11 @@
 				    bool packet_id,
 				    bool packet_id_long_form);
 
-void prng_init (void);
+#define NONCE_SECRET_LEN_MIN 16
+#define NONCE_SECRET_LEN_MAX 64
+void prng_init (const char *md_name, const int nonce_secret_len_parm);
 void prng_bytes (uint8_t *output, int len);
+void prng_uninit ();
 
 void test_crypto (const struct crypto_options *co, struct frame* f);
 
diff -urN openvpn-2.1_rc14/errlevel.h openvpn-2.1_rc15/errlevel.h
--- openvpn-2.1_rc14/errlevel.h	2008-11-17 03:14:54.000000000 +0100
+++ openvpn-2.1_rc15/errlevel.h	2008-11-18 01:55:06.000000000 +0100
@@ -140,6 +140,7 @@
 #define D_AUTO_USERID        LOGLEV(7, 70, M_DEBUG)  /* AUTO_USERID debugging */
 #define D_TLS_KEYSELECT      LOGLEV(7, 70, M_DEBUG)  /* show information on key selection for data channel */
 #define D_ARGV_PARSE_CMD     LOGLEV(7, 70, M_DEBUG)  /* show parse_line() errors in argv_printf %sc */
+#define D_CRYPTO_DEBUG       LOGLEV(7, 70, M_DEBUG)  /* show detailed info from crypto.c routines */
 #define D_PF_DROPPED_BCAST   LOGLEV(7, 71, M_DEBUG)  /* packet filter dropped a broadcast packet */
 #define D_PF_DEBUG           LOGLEV(7, 72, M_DEBUG)  /* packet filter debugging, must also define PF_DEBUG in pf.h */
 
@@ -153,7 +154,6 @@
 #define D_MULTI_TCP          LOGLEV(8, 70, M_DEBUG)  /* show debug info from mtcp.c */
 
 #define D_TLS_DEBUG          LOGLEV(9, 70, M_DEBUG)  /* show detailed info from TLS routines */
-#define D_CRYPTO_DEBUG       LOGLEV(9, 70, M_DEBUG)  /* show detailed info from crypto.c routines */
 #define D_COMP               LOGLEV(9, 70, M_DEBUG)  /* show compression info */
 #define D_READ_WRITE         LOGLEV(9, 70, M_DEBUG)  /* show all tun/tcp/udp reads/writes/opens */
 #define D_PACKET_CONTENT     LOGLEV(9, 70, M_DEBUG)  /* show before/after encryption packet content */
diff -urN openvpn-2.1_rc14/helper.c openvpn-2.1_rc15/helper.c
--- openvpn-2.1_rc14/helper.c	2008-11-02 07:34:00.000000000 +0100
+++ openvpn-2.1_rc15/helper.c	2008-11-18 05:53:58.000000000 +0100
@@ -96,6 +96,14 @@
   return BSTR (&out);
 }
 
+static const char *
+print_str (const char *str, struct gc_arena *gc)
+{
+  struct buffer out = alloc_buf_gc (128, gc);
+  buf_printf (&out, "%s", str);
+  return BSTR (&out);
+}
+
 static void
 helper_add_route (const in_addr_t network, const in_addr_t netmask, struct options *o)
 {
@@ -438,3 +446,34 @@
 	}
     }
 }
+
+/*
+ *
+ * HELPER DIRECTIVE:
+ *
+ * tcp-nodelay
+ *
+ * EXPANDS TO:
+ *
+ * if mode server:
+ *   socket-flags TCP_NODELAY
+ *   push "socket-flags TCP_NODELAY"
+ */
+void
+helper_tcp_nodelay (struct options *o)
+{
+#if P2MP_SERVER
+  if (o->server_flags & SF_TCP_NODELAY_HELPER)
+    {
+      if (o->mode == MODE_SERVER)
+	{
+	  o->sockflags |= SF_TCP_NODELAY;	  
+	  push_option (o, print_str ("socket-flags TCP_NODELAY", &o->gc), M_USAGE);
+	}
+      else
+	{
+	  ASSERT (0);
+	}
+    }
+#endif
+}
diff -urN openvpn-2.1_rc14/helper.h openvpn-2.1_rc15/helper.h
--- openvpn-2.1_rc14/helper.h	2008-10-06 09:22:21.000000000 +0200
+++ openvpn-2.1_rc15/helper.h	2008-11-18 05:53:58.000000000 +0100
@@ -33,5 +33,6 @@
 
 void helper_keepalive (struct options *o);
 void helper_client_server (struct options *o);
+void helper_tcp_nodelay (struct options *o);
 
 #endif
diff -urN openvpn-2.1_rc14/init.c openvpn-2.1_rc15/init.c
--- openvpn-2.1_rc14/init.c	2008-11-17 04:02:43.000000000 +0100
+++ openvpn-2.1_rc15/init.c	2008-11-18 01:39:39.000000000 +0100
@@ -401,7 +401,7 @@
   /* init PRNG used for IV generation */
   /* When forking, copy this to more places in the code to avoid fork
      random-state predictability */
-  prng_init ();
+  prng_init (NULL, 0);
 #endif
 
 #ifdef PID_TEST
@@ -473,6 +473,29 @@
   }
 #endif
 
+#ifdef PRNG_TEST
+  {
+    struct gc_arena gc = gc_new ();
+    uint8_t rndbuf[8];
+    int i;
+    prng_init ("sha1", 16);
+    //prng_init (NULL, 0);
+    const int factor = 1;
+    for (i = 0; i < factor * 8; ++i)
+      {
+#if 1
+	prng_bytes (rndbuf, sizeof (rndbuf));
+#else
+	ASSERT(RAND_bytes (rndbuf, sizeof (rndbuf)));
+#endif
+	printf ("[%d] %s\n", i, format_hex (rndbuf, sizeof (rndbuf), 0, &gc));
+      }
+    gc_free (&gc);
+    prng_uninit ();
+    return false;
+  }
+#endif
+
   return true;
 }
 
@@ -1634,6 +1657,9 @@
 		     options->ciphername_defined, options->authname,
 		     options->authname_defined, options->keysize, true, true);
 
+      /* Initialize PRNG with config-specified digest */
+      prng_init (options->prng_hash, options->prng_nonce_secret_len);
+
       /* TLS handshake authentication (--tls-auth) */
       if (options->tls_auth_file)
 	{
diff -urN openvpn-2.1_rc14/misc.c openvpn-2.1_rc15/misc.c
--- openvpn-2.1_rc14/misc.c	2008-11-17 05:01:16.000000000 +0100
+++ openvpn-2.1_rc15/misc.c	2008-11-19 18:59:32.000000000 +0100
@@ -1863,8 +1863,8 @@
     {
       for (i = 0; i < a->argc; ++i)
 	argv_append (&r, string_alloc (a->argv[i], NULL));
+      r.system_str = string_alloc (a->system_str, NULL);
     }
-  r.system_str = string_alloc (a->system_str, NULL);
   return r;
 }
 
diff -urN openvpn-2.1_rc14/openvpn.8 openvpn-2.1_rc15/openvpn.8
--- openvpn-2.1_rc14/openvpn.8	2008-11-17 04:08:45.000000000 +0100
+++ openvpn-2.1_rc15/openvpn.8	2008-11-18 06:09:27.000000000 +0100
@@ -26,7 +26,7 @@
 .\" LP paragraph
 .\" IP indented paragraph
 .\" TP hanging label
-.TH openvpn 8 "4 November 2008"
+.TH openvpn 8 "17 November 2008"
 .\"*********************************************************
 .SH NAME
 openvpn \- secure IP tunnel daemon.
@@ -36,278 +36,7 @@
 .nh
 .in +4
 .ti -4
-.B openvpn
-[\ \fB\-\-help\fR\ ]
-.in -4
-.ti +4
-.hy
-
-.nh
-.in +4
-.ti -4
-.B openvpn
-[\ \fB\-\-config\fR\ \fIfile\fR\ ]
-.in -4
-.ti +4
-.hy
-
-.nh
-.in +4
-.ti -4
-.B openvpn
-[\ \fB\-\-genkey\fR\ ]
-[\ \fB\-\-secret\fR\ \fIfile\fR\ ]
-.in -4
-.ti +4
-.hy
-
-.nh
-.in +4
-.ti -4
-.B openvpn
-[\ \fB\-\-mktun\fR\ ]
-[\ \fB\-\-rmtun\fR\ ]
-[\ \fB\-\-dev\fR\ \fItunX\ |\ tapX\fR\ ]
-[\ \fB\-\-dev\-type\fR\ \fIdevice\-type\fR\ ]
-[\ \fB\-\-dev\-node\fR\ \fInode\fR\ ]
-[\ \fB\-\-lladdr\fR\ \fIaddress\fR\ ]
-[\ \fB\-\-user\fR\ \fIuser\fR\ ]
-[\ \fB\-\-group\fR\ \fIgroup\fR\ ]
-.in -4
-.ti +4
-.hy
-
-.nh
-.in +4
-.ti -4
-.B openvpn
-[\ \fB\-\-test\-crypto\fR\ ]
-[\ \fB\-\-secret\fR\ \fIfile\fR\ ]
-[\ \fB\-\-auth\fR\ \fIalg\fR\ ]
-[\ \fB\-\-cipher\fR\ \fIalg\fR\ ]
-[\ \fB\-\-engine\fR\ ]
-[\ \fB\-\-keysize\fR\ \fIn\fR\ ]
-[\ \fB\-\-no\-replay\fR\ ]
-[\ \fB\-\-no\-iv\fR\ ]
-.in -4
-.ti +4
-.hy
-
-.nh
-.in +4
-.ti -4
-.B openvpn
-[\ \fB\-\-allow\-nonadmin\fR\ \fI[TAP\-adapter]\fR\ ]
-[\ \fB\-\-allow\-pull\-fqdn\fR\ ]
-[\ \fB\-\-askpass\fR\ \fI[file]\fR\ ]
-[\ \fB\-\-auth\-nocache\fR\ ]
-[\ \fB\-\-auth\-retry\fR\ \fItype\fR\ ]
-[\ \fB\-\-auth\-user\-pass\-optional\fR\ ]
-[\ \fB\-\-auth\-user\-pass\-verify\fR\ \fIscript\fR\ ]
-[\ \fB\-\-auth\-user\-pass\fR\ \fIup\fR\ ]
-[\ \fB\-\-auth\fR\ \fIalg\fR\ ]
-[\ \fB\-\-auto\-proxy\fR\ ]
-[\ \fB\-\-bcast\-buffers\fR\ \fIn\fR\ ]
-[\ \fB\-\-ca\fR\ \fIfile\fR\ ]
-[\ \fB\-\-ccd\-exclusive\fR\ ]
-[\ \fB\-\-cd\fR\ \fIdir\fR\ ]
-[\ \fB\-\-cert\fR\ \fIfile\fR\ ]
-[\ \fB\-\-chroot\fR\ \fIdir\fR\ ]
-[\ \fB\-\-cipher\fR\ \fIalg\fR\ ]
-[\ \fB\-\-client\-cert\-not\-required\fR\ ]
-[\ \fB\-\-client\-config\-dir\fR\ \fIdir\fR\ ]
-[\ \fB\-\-client\-connect\fR\ \fIscript\fR\ ]
-[\ \fB\-\-client\-disconnect\fR\ ]
-[\ \fB\-\-client\-to\-client\fR\ ]
-[\ \fB\-\-client\fR\ ]
-[\ \fB\-\-comp\-lzo\fR\ \fI[mode]\fR\ ]
-[\ \fB\-\-comp\-noadapt\fR\ ]
-[\ \fB\-\-config\fR\ \fIfile\fR\ ]
-[\ \fB\-\-connect\-freq\fR\ \fIn\ sec\fR\ ]
-[\ \fB\-\-connect\-retry\fR\ \fIn\fR\ ]
-[\ \fB\-\-connect\-retry\-max\fR\ \fIn\fR\ ]
-[\ \fB\-\-crl\-verify\fR\ \fIcrl\fR\ ]
-[\ \fB\-\-cryptoapicert\fR\ \fIselect\-string\fR\ ]
-[\ \fB\-\-daemon\fR\ \fI[progname]\fR\ ]
-[\ \fB\-\-dev\-node\fR\ \fInode\fR\ ]
-[\ \fB\-\-dev\-type\fR\ \fIdevice\-type\fR\ ]
-[\ \fB\-\-dev\fR\ \fItunX\ |\ tapX\ |\ null\fR\ ]
-[\ \fB\-\-dev\fR\ \fItunX\ |\ tapX\fR\ ]
-[\ \fB\-\-dh\fR\ \fIfile\fR\ ]
-[\ \fB\-\-dhcp\-option\fR\ \fItype\ [parm]\fR\ ]
-[\ \fB\-\-dhcp\-release\fR\ ]
-[\ \fB\-\-dhcp\-renew\fR\ ]
-[\ \fB\-\-disable\-occ\fR\ ]
-[\ \fB\-\-disable\fR\ ]
-[\ \fB\-\-down\-pre\fR\ ]
-[\ \fB\-\-down\fR\ \fIcmd\fR\ ]
-[\ \fB\-\-duplicate\-cn\fR\ ]
-[\ \fB\-\-echo\fR\ \fI[parms...]\fR\ ]
-[\ \fB\-\-engine\fR\ \fI[engine\-name]\fR\ ]
-[\ \fB\-\-explicit\-exit\-notify\fR\ \fI[n]\fR\ ]
-[\ \fB\-\-fast\-io\fR\ ]
-[\ \fB\-\-float\fR\ ]
-[\ \fB\-\-fragment\fR\ \fImax\fR\ ]
-[\ \fB\-\-genkey\fR\ ]
-[\ \fB\-\-group\fR\ \fIgroup\fR\ ]
-[\ \fB\-\-hand\-window\fR\ \fIn\fR\ ]
-[\ \fB\-\-hash\-size\fR\ \fIr\ v\fR\ ]
-[\ \fB\-\-help\fR\ ]
-[\ \fB\-\-http\-proxy\-option\fR\ \fItype\ [parm]\fR\ ]
-[\ \fB\-\-http\-proxy\-retry\fR\ ]
-[\ \fB\-\-http\-proxy\-timeout\fR\ \fIn\fR\ ]
-[\ \fB\-\-http\-proxy\fR\ \fIserver\ port\ [authfile]\ [auth\-method]\fR\ ]
-[\ \fB\-\-ifconfig\-noexec\fR\ ]
-[\ \fB\-\-ifconfig\-nowarn\fR\ ]
-[\ \fB\-\-ifconfig\-pool\-linear\fR\ ]
-[\ \fB\-\-ifconfig\-pool\-persist\fR\ \fIfile\ [seconds]\fR\ ]
-[\ \fB\-\-ifconfig\-pool\fR\ \fIstart\-IP\ end\-IP\ [netmask]\fR\ ]
-[\ \fB\-\-ifconfig\-push\fR\ \fIlocal\ remote\-netmask\fR\ ]
-[\ \fB\-\-ifconfig\fR\ \fIl\ rn\fR\ ]
-[\ \fB\-\-inactive\fR\ \fIn\ [bytes]\fR\ ]
-[\ \fB\-\-inetd\fR\ \fI[wait|nowait]\ [progname]\fR\ ]
-[\ \fB\-\-ip\-win32\fR\ \fImethod\fR\ ]
-[\ \fB\-\-ipchange\fR\ \fIcmd\fR\ ]
-[\ \fB\-\-iproute\fR\ \fIcmd\fR\ ]
-[\ \fB\-\-iroute\fR\ \fInetwork\ [netmask]\fR\ ]
-[\ \fB\-\-keepalive\fR\ \fIn\ m\fR\ ]
-[\ \fB\-\-key\-method\fR\ \fIm\fR\ ]
-[\ \fB\-\-key\fR\ \fIfile\fR\ ]
-[\ \fB\-\-keysize\fR\ \fIn\fR\ ]
-[\ \fB\-\-learn\-address\fR\ \fIcmd\fR\ ]
-[\ \fB\-\-link\-mtu\fR\ \fIn\fR\ ]
-[\ \fB\-\-local\fR\ \fIhost\fR\ ]
-[\ \fB\-\-log\-append\fR\ \fIfile\fR\ ]
-[\ \fB\-\-log\fR\ \fIfile\fR\ ]
-[\ \fB\-\-suppress-timestamps\fR\ ]
-[\ \fB\-\-lport\fR\ \fIport\fR\ ]
-[\ \fB\-\-management\-client\-auth\fR\ ]
-[\ \fB\-\-management\-client\-group\fR\ \fIg\fR\ ]
-[\ \fB\-\-management\-client\-pf\fR\ ]
-[\ \fB\-\-management\-client\-user\fR\ \fIu\fR\ ]
-[\ \fB\-\-management\-forget\-disconnect\fR\ ]
-[\ \fB\-\-management\-hold\fR\ ]
-[\ \fB\-\-management\-log\-cache\fR\ \fIn\fR\ ]
-[\ \fB\-\-management\-signal\fR\ ]
-[\ \fB\-\-management\-query\-passwords\fR\ ]
-[\ \fB\-\-management\fR\ \fIIP\ port\ [pw\-file]\fR\ ]
-[\ \fB\-\-max\-clients\fR\ \fIn\fR\ ]
-[\ \fB\-\-max\-routes\-per\-client\fR\ \fIn\fR\ ]
-[\ \fB\-\-mktun\fR\ ]
-[\ \fB\-\-mlock\fR\ ]
-[\ \fB\-\-mode\fR\ \fIm\fR\ ]
-[\ \fB\-\-mssfix\fR\ \fImax\fR\ ]
-[\ \fB\-\-mtu\-disc\fR\ \fItype\fR\ ]
-[\ \fB\-\-mtu\-test\fR\ ]
-[\ \fB\-\-mute\-replay\-warnings\fR\ ]
-[\ \fB\-\-mute\fR\ \fIn\fR\ ]
-[\ \fB\-\-nice\fR\ \fIn\fR\ ]
-[\ \fB\-\-no\-iv\fR\ ]
-[\ \fB\-\-no\-name\-remapping\fR\ ]
-[\ \fB\-\-no\-replay\fR\ ]
-[\ \fB\-\-bind\fR\ ]
-[\ \fB\-\-nobind\fR\ ]
-[\ \fB\-\-ns\-cert\-type\fR\ \fIclient|server\fR\ ]
-[\ \fB\-\-passtos\fR\ ]
-[\ \fB\-\-pause\-exit\fR\ ]
-[\ \fB\-\-persist\-key\fR\ ]
-[\ \fB\-\-persist\-local\-ip\fR\ ]
-[\ \fB\-\-persist\-remote\-ip\fR\ ]
-[\ \fB\-\-persist\-tun\fR\ ]
-[\ \fB\-\-ping\-exit\fR\ \fIn\fR\ ]
-[\ \fB\-\-ping\-restart\fR\ \fIn\fR\ ]
-[\ \fB\-\-ping\-timer\-rem\fR\ ]
-[\ \fB\-\-ping\fR\ \fIn\fR\ ]
-[\ \fB\-\-pkcs11\-cert\-private\fR\ \fI[0|1]...\fR\ ]
-[\ \fB\-\-pkcs11\-id\fR\ \fIname\fR\ ]
-[\ \fB\-\-pkcs11\-id\-management\fR\ ]
-[\ \fB\-\-pkcs11\-pin\-cache\fR\ \fIseconds\fR\ ]
-[\ \fB\-\-pkcs11\-private\-mode\fR\ \fImode...\fR\ ]
-[\ \fB\-\-pkcs11\-protected\-authentication\fR\ \fI[0|1]...\fR\ ]
-[\ \fB\-\-pkcs11\-providers\fR\ \fIprovider...\fR\ ]
-[\ \fB\-\-pkcs12\fR\ \fIfile\fR\ ]
-[\ \fB\-\-plugin\fR\ \fImodule\-pathname\ init\-string\fR\ ]
-[\ \fB\-\-port\fR\ \fIport\fR\ ]
-[\ \fB\-\-port\-share\fR\ \fIhost\ port\fR\ ]
-[\ \fB\-\-proto\fR\ \fIp\fR\ ]
-[\ \fB\-\-pull\fR\ ]
-[\ \fB\-\-push\-reset\fR\ ]
-[\ \fB\-\-push\fR\ \fI"option"\fR\ ]
-[\ \fB\-\-rcvbuf\fR\ \fIsize\fR\ ]
-[\ \fB\-\-redirect\-gateway\fR\ \fIflags...\fR\ ]
-[\ \fB\-\-remap\-usr1\fR\ \fIsignal\fR\ ]
-[\ \fB\-\-remote\-random\fR\ ]
-[\ \fB\-\-remote\fR\ \fIhost\ [port]\fR\ ]
-[\ \fB\-\-remote\-cert\-ku\ \fIv...\fR\ ]
-[\ \fB\-\-remote\-cert\-eku\ \fIoid\fR\ ]
-[\ \fB\-\-remote\-cert\-tls\ \fIt\fR\ ]
-[\ \fB\-\-reneg\-bytes\fR\ \fIn\fR\ ]
-[\ \fB\-\-reneg\-pkts\fR\ \fIn\fR\ ]
-[\ \fB\-\-reneg\-sec\fR\ \fIn\fR\ ]
-[\ \fB\-\-replay\-persist\fR\ \fIfile\fR\ ]
-[\ \fB\-\-replay\-window\fR\ \fIn\ [t]\fR\ ]
-[\ \fB\-\-resolv\-retry\fR\ \fIn\fR\ ]
-[\ \fB\-\-rmtun\fR\ ]
-[\ \fB\-\-route\-delay\fR\ \fI[n]\ [w]\fR\ ]
-[\ \fB\-\-route\-gateway\fR\ \fIgw\fR\ ]
-[\ \fB\-\-route\-method\fR\ \fIm\fR\ ]
-[\ \fB\-\-route\-metric\fR\ \fIm\fR\ ]
-[\ \fB\-\-route\-noexec\fR\ ]
-[\ \fB\-\-route\-nopull\fR\ ]
-[\ \fB\-\-route\-up\fR\ \fIcmd\fR\ ]
-[\ \fB\-\-route\fR\ \fInetwork\ [netmask]\ [gateway]\ [metric]\fR\ ]
-[\ \fB\-\-rport\fR\ \fIport\fR\ ]
-[\ \fB\-\-script\-security\fR\ \fIlevel\fR\ ]
-[\ \fB\-\-secret\fR\ \fIfile\ [direction]\fR\ ]
-[\ \fB\-\-secret\fR\ \fIfile\fR\ ]
-[\ \fB\-\-server\-bridge\fR\ \fIgateway\ netmask\ pool\-start\-IP\ pool\-end\-IP\fR\ ]
-[\ \fB\-\-server\fR\ \fInetwork\ netmask\fR\ ]
-[\ \fB\-\-service\fR\ \fIexit\-event\ [0|1]\fR\ ]
-[\ \fB\-\-setenv\fR\ \fIname\ value\fR\ ]
-[\ \fB\-\-setenv\-safe\fR\ \fIname\ value\fR\ ]
-[\ \fB\-\-shaper\fR\ \fIn\fR\ ]
-[\ \fB\-\-show\-adapters\fR\ ]
-[\ \fB\-\-show\-ciphers\fR\ ]
-[\ \fB\-\-show\-digests\fR\ ]
-[\ \fB\-\-show\-engines\fR\ ]
-[\ \fB\-\-show\-pkcs11\-ids\fR\ \fIprovider\ [cert_private]\fR\ ]
-[\ \fB\-\-show\-net\-up\fR\ ]
-[\ \fB\-\-show\-net\fR\ ]
-[\ \fB\-\-show\-tls\fR\ ]
-[\ \fB\-\-show\-valid\-subnets\fR\ ]
-[\ \fB\-\-single\-session\fR\ ]
-[\ \fB\-\-sndbuf\fR\ \fIsize\fR\ ]
-[\ \fB\-\-socks\-proxy\-retry\fR\ ]
-[\ \fB\-\-socks\-proxy\fR\ \fIserver\ [port]\fR\ ]
-[\ \fB\-\-status\fR\ \fIfile\ [n]\fR\ ]
-[\ \fB\-\-status\-version\fR\ \fIn\fR\ ]
-[\ \fB\-\-syslog\fR\ \fI[progname]\fR\ ]
-[\ \fB\-\-tap\-sleep\fR\ \fIn\fR\ ]
-[\ \fB\-\-tcp\-queue\-limit\fR\ \fIn\fR\ ]
-[\ \fB\-\-test\-crypto\fR\ ]
-[\ \fB\-\-tls\-auth\fR\ \fIfile\ [direction]\fR\ ]
-[\ \fB\-\-tls\-cipher\fR\ \fIl\fR\ ]
-[\ \fB\-\-tls\-client\fR\ ]
-[\ \fB\-\-tls\-exit\fR\ ]
-[\ \fB\-\-tls\-remote\fR\ \fIx509name\fR\ ]
-[\ \fB\-\-tls\-server\fR\ ]
-[\ \fB\-\-tls\-timeout\fR\ \fIn\fR\ ]
-[\ \fB\-\-tls\-verify\fR\ \fIcmd\fR\ ]
-[\ \fB\-\-tmp\-dir\fR\ \fIdir\fR\ ]
-[\ \fB\-\-topology\fR\ \fImode\fR\ ]
-[\ \fB\-\-tran\-window\fR\ \fIn\fR\ ]
-[\ \fB\-\-tun\-ipv6\fR\ ]
-[\ \fB\-\-tun\-mtu\-extra\fR\ \fIn\fR\ ]
-[\ \fB\-\-tun\-mtu\fR\ \fIn\fR\ ]
-[\ \fB\-\-txqueuelen\fR\ \fIn\fR\ ]
-[\ \fB\-\-up\-delay\fR\ ]
-[\ \fB\-\-up\-restart\fR\ ]
-[\ \fB\-\-up\fR\ \fIcmd\fR\ ]
-[\ \fB\-\-user\fR\ \fIuser\fR\ ]
-[\ \fB\-\-username\-as\-common\-name\fR\ ]
-[\ \fB\-\-verb\fR\ \fIn\fR\ ]
-[\ \fB\-\-win\-sys\fR\ \fIpath|'env'\fR\ ]
-[\ \fB\-\-writepid\fR\ \fIfile\fR\ ]
+.B openvpn [ options ... ]
 .in -4
 .ti +4
 .hy
@@ -3137,6 +2866,31 @@
 at this client.
 .\"*********************************************************
 .TP
+.B --tcp-nodelay
+This macro sets the TCP_NODELAY socket flag on the server
+as well as pushes it to connecting clients.  The TCP_NODELAY
+flag disables the Nagle algorithm on TCP sockets causing
+packets to be transmitted immediately with low latency,
+rather than waiting a short period of time in order
+to aggregate several packets into a larger containing
+packet.  In VPN applications over TCP, TCP_NODELAY
+is generally a good latency optimization.
+
+The macro expands as follows:
+
+.RS
+.ft 3
+.nf
+.sp
+ if mode server:
+   socket-flags TCP_NODELAY
+   push "socket-flags TCP_NODELAY"
+.ft
+.LP
+.RE
+.fi
+.\"*********************************************************
+.TP
 .B --max-clients n
 Limit server to a maximum of
 .B n
@@ -3288,6 +3042,20 @@
 in the OpenVPN source distribution.
 .\"*********************************************************
 .TP
+.B --opt-verify
+Clients that connect with options that are incompatible
+with those of the server will be disconnected.
+
+Options that will be compared for compatibility include
+dev-type, link-mtu, tun-mtu, proto, tun-ipv6, ifconfig,
+comp-lzo, fragment, keydir, cipher, auth, keysize, secret,
+no-replay, no-iv, tls-auth, key-method, tls-server, and tls-client.
+
+This option requires that
+.B --disable-occ
+NOT be used.
+.\"*********************************************************
+.TP
 .B --auth-user-pass-optional
 Allow connections by clients that do not specify a username/password.
 Normally, when
@@ -3616,6 +3384,21 @@
 security, or may even reduce security.
 .\"*********************************************************
 .TP
+.B --prng alg [nsl]
+(Advanced) For PRNG (Pseudo-random number generator),
+use digest algorithm
+.B alg
+(default=sha1), and set
+.B nsl
+(default=16)
+to the size in bytes of the nonce secret length (between 16 and 64).
+
+Set
+.B alg=none
+to disable the PRNG and use the OpenSSL RAND_bytes function
+instead for all of OpenVPN's pseudo-random number needs.
+.\"*********************************************************
+.TP
 .B --engine [engine-name]
 Enable OpenSSL hardware-based crypto engine functionality.
 
diff -urN openvpn-2.1_rc14/openvpn.spec openvpn-2.1_rc15/openvpn.spec
--- openvpn-2.1_rc14/openvpn.spec	2008-11-17 05:39:49.000000000 +0100
+++ openvpn-2.1_rc15/openvpn.spec	2008-11-19 19:18:24.000000000 +0100
@@ -16,7 +16,7 @@
 
 Summary:	OpenVPN is a robust and highly flexible VPN daemon by James Yonan.
 Name:           openvpn
-Version:        2.1_rc14
+Version:        2.1_rc15
 Release:	1
 URL:		http://openvpn.net/
 Source0:	http://prdownloads.sourceforge.net/openvpn/%{name}-%{version}.tar.gz
diff -urN openvpn-2.1_rc14/options.c openvpn-2.1_rc15/options.c
--- openvpn-2.1_rc14/options.c	2008-11-17 04:23:51.000000000 +0100
+++ openvpn-2.1_rc15/options.c	2008-11-18 05:59:13.000000000 +0100
@@ -384,6 +384,8 @@
   "                  run script cmd to verify.  If method='via-env', pass\n"
   "                  user/pass via environment, if method='via-file', pass\n"
   "                  user/pass via temporary file.\n"
+  "--opt-verify    : Clients that connect with options that are incompatible\n"
+  "                  with those of the server will be disconnected.\n"
   "--auth-user-pass-optional : Allow connections by clients that don't\n"
   "                  specify a username/password.\n"
   "--no-name-remapping : Allow Common Name and X509 Subject to include\n"
@@ -400,6 +402,8 @@
   "                  virtual address table to v.\n"
   "--bcast-buffers n : Allocate n broadcast buffers.\n"
   "--tcp-queue-limit n : Maximum number of queued TCP output packets.\n"
+  "--tcp-nodelay   : Macro that sets TCP_NODELAY socket flag on the server\n"
+  "                  as well as pushes it to connecting clients.\n"
   "--learn-address cmd : Run script cmd to validate client virtual addresses.\n"
   "--connect-freq n s : Allow a maximum of n new connections per s seconds.\n"
   "--max-clients n : Allow a maximum of n simultaneously connected clients.\n"
@@ -442,6 +446,8 @@
   "--cipher alg    : Encrypt packets with cipher algorithm alg\n"
   "                  (default=%s).\n"
   "                  Set alg=none to disable encryption.\n"
+  "--prng alg [nsl] : For PRNG, use digest algorithm alg, and\n"
+  "                   nonce_secret_len=nsl.  Set alg=none to disable PRNG.\n"
 #ifdef HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH
   "--keysize n     : Size of cipher key in bits (optional).\n"
   "                  If unspecified, defaults to cipher-specific default.\n"
@@ -717,6 +723,8 @@
   o->ciphername_defined = true;
   o->authname = "SHA1";
   o->authname_defined = true;
+  o->prng_hash = "SHA1";
+  o->prng_nonce_secret_len = 16;
   o->replay = true;
   o->replay_window = DEFAULT_SEQ_BACKTRACK;
   o->replay_time = DEFAULT_TIME_BACKTRACK;
@@ -1272,6 +1280,8 @@
   SHOW_STR (ciphername);
   SHOW_BOOL (authname_defined);
   SHOW_STR (authname);
+  SHOW_STR (prng_hash);
+  SHOW_INT (prng_nonce_secret_len);
   SHOW_INT (keysize);
   SHOW_BOOL (engine);
   SHOW_BOOL (replay);
@@ -1752,6 +1762,12 @@
 	msg (M_USAGE, "--username-as-common-name requires --mode server");
       if (options->ssl_flags & SSLF_AUTH_USER_PASS_OPTIONAL)
 	msg (M_USAGE, "--auth-user-pass-optional requires --mode server");
+      if (options->ssl_flags & SSLF_NO_NAME_REMAPPING)
+	msg (M_USAGE, "--no-name-remapping requires --mode server");
+      if (options->ssl_flags & SSLF_OPT_VERIFY)
+	msg (M_USAGE, "--opt-verify requires --mode server");
+      if (options->server_flags & SF_TCP_NODELAY_HELPER)
+	msg (M_USAGE, "--tcp-nodelay requires --mode server");
       if (options->auth_user_pass_verify_script)
 	msg (M_USAGE, "--auth-user-pass-verify requires --mode server");
 #if PORT_SHARE
@@ -2053,6 +2069,7 @@
    */
   helper_client_server (o);
   helper_keepalive (o);
+  helper_tcp_nodelay (o);
 
   options_postprocess_mutate_invariant (o);
 
@@ -4619,6 +4636,11 @@
       VERIFY_PERMISSION (OPT_P_GENERAL);
       options->ssl_flags |= SSLF_NO_NAME_REMAPPING;
     }
+  else if (streq (p[0], "opt-verify"))
+    {
+      VERIFY_PERMISSION (OPT_P_GENERAL);
+      options->ssl_flags |= SSLF_OPT_VERIFY;
+    }
   else if (streq (p[0], "auth-user-pass-verify") && p[1])
     {
       VERIFY_PERMISSION (OPT_P_SCRIPT);
@@ -4780,6 +4802,11 @@
       VERIFY_PERMISSION (OPT_P_INSTANCE);
       options->disable = true;
     }
+  else if (streq (p[0], "tcp-nodelay"))
+    {
+      VERIFY_PERMISSION (OPT_P_GENERAL);
+      options->server_flags |= SF_TCP_NODELAY_HELPER;
+    }
 #endif /* P2MP_SERVER */
 
   else if (streq (p[0], "client"))
@@ -5158,6 +5185,28 @@
       VERIFY_PERMISSION (OPT_P_CRYPTO);
       options->ciphername_defined = true;
     }
+  else if (streq (p[0], "prng") && p[1])
+    {
+      VERIFY_PERMISSION (OPT_P_CRYPTO);
+      if (streq (p[1], "none"))
+	options->prng_hash = NULL;
+      else
+	options->prng_hash = p[1];
+      if (p[2])
+	{
+	  const int sl = atoi (p[2]);
+	  if (sl >= NONCE_SECRET_LEN_MIN && sl <= NONCE_SECRET_LEN_MAX)
+	    {
+	      options->prng_nonce_secret_len = sl;
+	    }
+	  else
+	    {
+	      msg (msglevel, "prng parameter nonce_secret_len must be between %d and %d",
+		   NONCE_SECRET_LEN_MIN, NONCE_SECRET_LEN_MAX);
+	      goto err;
+	    }
+	}
+    }
   else if (streq (p[0], "no-replay"))
     {
       VERIFY_PERMISSION (OPT_P_CRYPTO);
diff -urN openvpn-2.1_rc14/options.h openvpn-2.1_rc15/options.h
--- openvpn-2.1_rc14/options.h	2008-11-04 21:08:47.000000000 +0100
+++ openvpn-2.1_rc15/options.h	2008-11-18 05:43:47.000000000 +0100
@@ -346,6 +346,7 @@
   in_addr_t server_netmask;
 
 # define SF_NOPOOL (1<<0)
+# define SF_TCP_NODELAY_HELPER (1<<1)
   unsigned int server_flags;
 
   bool server_bridge_proxy_dhcp;
@@ -418,6 +419,8 @@
   bool authname_defined;
   const char *authname;
   int keysize;
+  const char *prng_hash;
+  int prng_nonce_secret_len;
   const char *engine;
   bool replay;
   bool mute_replay_warnings;
diff -urN openvpn-2.1_rc14/ps.c openvpn-2.1_rc15/ps.c
--- openvpn-2.1_rc14/ps.c	2008-10-06 09:22:21.000000000 +0200
+++ openvpn-2.1_rc15/ps.c	2008-11-17 21:00:22.000000000 +0100
@@ -793,7 +793,7 @@
       set_nonblock (fd[1]);
 
       /* initialize prng */
-      prng_init ();
+      prng_init (NULL, 0);
 
       /* execute the event loop */
       port_share_proxy (hostaddr, port, fd[1]);
diff -urN openvpn-2.1_rc14/ssl.c openvpn-2.1_rc15/ssl.c
--- openvpn-2.1_rc14/ssl.c	2008-10-31 07:37:45.000000000 +0100
+++ openvpn-2.1_rc15/ssl.c	2008-11-18 03:57:27.000000000 +0100
@@ -3465,6 +3465,11 @@
       !options_cmp_equal (options, session->opt->remote_options))
     {
       options_warning (options, session->opt->remote_options);
+      if (session->opt->ssl_flags & SSLF_OPT_VERIFY)
+	{
+	  msg (D_TLS_ERRORS, "Option inconsistency warnings triggering disconnect due to --opt-verify");
+	  ks->authenticated = false;
+	}
     }
 #endif
 
diff -urN openvpn-2.1_rc14/ssl.h openvpn-2.1_rc15/ssl.h
--- openvpn-2.1_rc14/ssl.h	2008-10-31 07:37:44.000000000 +0100
+++ openvpn-2.1_rc15/ssl.h	2008-11-18 03:44:06.000000000 +0100
@@ -469,6 +469,7 @@
 # define SSLF_USERNAME_AS_COMMON_NAME  (1<<1)
 # define SSLF_AUTH_USER_PASS_OPTIONAL  (1<<2)
 # define SSLF_NO_NAME_REMAPPING        (1<<3)
+# define SSLF_OPT_VERIFY               (1<<4)
   unsigned int ssl_flags;
 
 #ifdef MANAGEMENT_DEF_AUTH
diff -urN openvpn-2.1_rc14/version.m4 openvpn-2.1_rc15/version.m4
--- openvpn-2.1_rc14/version.m4	2008-11-17 05:38:35.000000000 +0100
+++ openvpn-2.1_rc15/version.m4	2008-11-19 19:08:50.000000000 +0100
@@ -1,5 +1,5 @@
 dnl define the OpenVPN version
-define(PRODUCT_VERSION,[2.1_rc14])
+define(PRODUCT_VERSION,[2.1_rc15])
 dnl define the TAP version
 define(PRODUCT_TAP_ID,[tap0901])
 define(PRODUCT_TAP_WIN32_MIN_MAJOR,[9])

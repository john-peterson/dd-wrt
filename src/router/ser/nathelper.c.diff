--- ser-0.8.14.orig/modules/nathelper/nathelper.c	2004-07-15 23:18:34.000000000 +0200
+++ ser-0.8.14/modules/nathelper/nathelper.c	2005-05-10 21:50:35.126386416 +0200
@@ -174,7 +174,8 @@
 #define	CPORT		"22222"
 
 static int nat_uac_test_f(struct sip_msg* msg, char* str1, char* str2);
-static int fix_nated_contact_f(struct sip_msg *, char *, char *);
+static int fix_nated_contact0_f(struct sip_msg *, char *, char *);
+static int fix_nated_contact1_f(struct sip_msg *, char *, char *);
 static int fix_nated_sdp_f(struct sip_msg *, char *, char *);
 static int extract_mediaip(str *, str *, int *);
 static int extract_mediaport(str *, str *);
@@ -226,7 +227,8 @@
 static unsigned int myseqn = 0;
 
 static cmd_export_t cmds[] = {
-	{"fix_nated_contact", fix_nated_contact_f,    0, 0,             REQUEST_ROUTE | ONREPLY_ROUTE },
+	{"fix_nated_contact", fix_nated_contact0_f,   0, 0,             REQUEST_ROUTE | ONREPLY_ROUTE },
+	{"fix_nated_contact", fix_nated_contact1_f,   1, 0,             REQUEST_ROUTE | ONREPLY_ROUTE },
 	{"fix_nated_sdp",     fix_nated_sdp_f,        1, fixup_str2int, REQUEST_ROUTE | ONREPLY_ROUTE | FAILURE_ROUTE },
 	{"unforce_rtp_proxy", unforce_rtp_proxy_f,    0, 0,             REQUEST_ROUTE | ONREPLY_ROUTE | FAILURE_ROUTE },
 	{"force_rtp_proxy",   force_rtp_proxy0_f,     0, 0,             REQUEST_ROUTE | ONREPLY_ROUTE },
@@ -511,7 +513,7 @@
  * of the packet.
  */
 static int
-fix_nated_contact_f(struct sip_msg* msg, char* str1, char* str2)
+fix_nated_contact1_f(struct sip_msg* msg, char* str1, char* str2)
 {
 	int offset, len, len1;
 	char *cp, *buf, temp[2];
@@ -531,7 +533,14 @@
 	if (anchor == 0)
 		return -1;
 
-	cp = ip_addr2a(&msg->rcv.src_ip);
+        if (*str1 == '\0')
+        {
+                cp = ip_addr2a(&msg->rcv.src_ip);
+        }
+        else
+        {
+                cp = str1;
+        }
 	len = c->uri.len + strlen(cp) + 6 /* :port */ - (uri.port.s + uri.port.len - uri.host.s) + 1;
 	buf = pkg_malloc(len);
 	if (buf == NULL) {
@@ -557,6 +566,15 @@
 	return 1;
 }
 
+static int
+fix_nated_contact0_f(struct sip_msg* msg, char* str1, char* str2)
+{
+	char arg[1] = {'\0'};
+
+	return fix_nated_contact1_f(msg, arg, NULL);
+}
+
+
 inline static int
 fixup_str2int( void** param, int param_no)
 {
@@ -1402,6 +1420,7 @@
 	if (alter_mediaport(msg, &body, &oldport, &newport, 0) == -1)
 		return -1;
 
+/* SIPATH: no insertion of nortpproxy:yes as sometimes second rtpproxy in the internet is needed 
 	if (proxied == 0) {
 		cp = pkg_malloc(ANORTPPROXY_LEN * sizeof(char));
 		if (cp == NULL) {
@@ -1421,7 +1440,7 @@
 			return -1;
 		}
 	}
-
+*/
 	return 1;
 }
 

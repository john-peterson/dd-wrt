#!/bin/sh
#export DEFDAYS=365
#export CC_COUNTRY="DE"
#export CC_STATE="hessen"
#export CC_LOCALITY="woanners"
#export CC_ORGANISATION="ICHAG"
#export CC_EMAIL="email1@ichag"
#export CC_COMMONNAME="clientcert2"


export DEFDAYS=$1
export CC_COUNTRY=$2
export CC_STATE=$3
export CC_LOCALITY=$4
export CC_ORGANISATION=$5
export CC_EMAIL=$6
export CC_COMMONNAME=$7
#key
mkdir -p clients
openssl req -batch -nodes -new -x509 -keyout clients/${CC_COMMONNAME}-key.pem -out clients/${CC_COMMONNAME}-req.pem -days $DEFDAYS -config client.cnf
#signing-request
openssl x509 -x509toreq -in clients/${CC_COMMONNAME}-req.pem -signkey clients/${CC_COMMONNAME}-key.pem -out clients/${CC_COMMONNAME}-tmp.pem
openssl ca -batch -config server.cnf -policy policy_anything -out clients/${CC_COMMONNAME}-cert.pem -passin pass:`grep output_password server.cnf | sed 's/.*=//;s/^ *//'` -extensions xpclient_ext -extfile xpextensions -infiles clients/${CC_COMMONNAME}-tmp.pem
openssl pkcs12 -export -in clients/${CC_COMMONNAME}-cert.pem -passout pass:`grep output_password server.cnf | sed 's/.*=//;s/^ *//'` -out clients/${CC_COMMONNAME}-cert.p12 -inkey clients/${CC_COMMONNAME}-key.pem -descert
rm -f clients/${CC_COMMONNAME}-tmp.pem
